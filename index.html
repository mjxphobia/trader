<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>어둠의 거래소 - ROUND 1</title>

<style>
  html,body{
    margin:0; padding:0; width:100%; height:100%;
    overflow:hidden; overscroll-behavior:none; touch-action:none;
    background:#000;
    font-family: Arial, Helvetica, sans-serif;
    color:#f2f2f2;
  }
  :root{ --vh:1vh; }
  body{ height: calc(var(--vh) * 100); }

  .wrap{ width:100%; height:100%; display:flex; justify-content:center; }
  #scaleRoot{ width: 980px; transform-origin: top center; }
  .frame{
    width: 940px;
    margin: 10px auto 0;
    border:2px solid rgba(255,255,255,0.65);
    background: radial-gradient(circle at 50% 35%, #101018 0%, #06060a 55%, #000 100%);
    box-sizing:border-box;
    padding: 10px 12px 14px;
  }

  .pixel{
    image-rendering: pixelated;
    image-rendering: crisp-edges;
  }

  .titleBar{
    height: 44px;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:14px;
    color:#fff;
    font-weight:800;
    letter-spacing:0.5px;
    border:2px solid rgba(255,255,255,0.45);
    background: repeating-linear-gradient(
      90deg,
      rgba(255,255,255,0.05) 0px,
      rgba(255,255,255,0.05) 12px,
      rgba(255,255,255,0.0) 12px,
      rgba(255,255,255,0.0) 24px
    );
  }
  .titleBar small{ opacity:0.9; font-weight:700; }

  .view{ display:none; }
  .view.active{ display:block; }

  .card{
    border:2px solid rgba(255,255,255,0.55);
    background: rgba(0,0,0,0.35);
    box-sizing:border-box;
  }

  /* 말풍선(왼쪽 꼬리) */
  .bubble{
    position:relative;
    padding: 12px 14px;
    min-height: 64px;
    display:flex;
    align-items:center;
    font-weight:800;
    font-size:16px;
    line-height:1.2;
    border:2px solid rgba(255,255,255,0.65);
    background: rgba(10,10,16,0.65);
    text-align:left;
    box-sizing:border-box;
    white-space:pre-line;
  }
  .bubble::before{
    content:"";
    position:absolute;
    left:-12px;
    top:22px;
    width:0; height:0;
    border-top:10px solid transparent;
    border-bottom:10px solid transparent;
    border-right:12px solid rgba(255,255,255,0.65);
  }
  .bubble::after{
    content:"";
    position:absolute;
    left:-9px;
    top:23px;
    width:0; height:0;
    border-top:9px solid transparent;
    border-bottom:9px solid transparent;
    border-right:11px solid rgba(10,10,16,0.65);
  }

  button{
    border:2px solid rgba(255,255,255,0.7);
    background: rgba(0,0,0,0.25);
    color:#fff;
    font-weight:800;
    cursor:pointer;
    user-select:none;
    -webkit-user-select:none;
    touch-action: manipulation;
  }
  button:active{ transform: translateY(1px); }

  /* ===== 1페이지(입장) ===== */
  .s1Top{
    width: 92%;
    margin: 14px auto 0;
    display:flex;
    align-items:center;
    justify-content:center;
    gap: 14px;
  }
  .s1Stranger{
    width: 220px;
    height: 200px;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:10px;
    flex: 0 0 auto;
  }
  .s1Stranger img{
    width:100%; height:100%;
    object-fit:contain;
    pointer-events:none;
  }
  .s1Top .bubble{ flex:1; }

  .s1Center{
    width: 92%;
    margin: 18px auto 0;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap: 14px;
  }
  .entryBtn{
    width: 92%;
    max-width: 760px;
    padding: 14px 16px;
    font-size:16px;
    line-height:1.3;
    text-align:center;
  }

  .circleRow{
    display:flex;
    justify-content:center;
    gap:14px;
    margin-top: 6px;
  }
  .circleBtn{
    width: 92px;
    height: 44px;
    border-radius:999px;
    font-size:14px;
    background: rgba(0,0,0,0.35);
  }

  /* ===== 2페이지(게임) ===== */
  .s2Top{
    width: 92%;
    margin: 14px auto 0;
    display:flex;
    align-items:center;
    justify-content:center;
    gap: 14px;
  }
  .s2StrangerSmall{
    width: 150px;
    height: 120px;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:8px;
    flex: 0 0 auto;
  }
  .s2StrangerSmall img{
    width:100%; height:100%;
    object-fit:contain;
    pointer-events:none;
  }
  .s2Top .bubble{ flex:1; min-height:64px; }

  .rpsBanner{
    width: 92%;
    margin: 14px auto 10px;
    padding: 12px;
    text-align:center;
    font-weight:900;
    font-size:32px;
    border:2px solid rgba(255,255,255,0.6);
    background: rgba(0,0,0,0.3);
  }

  .arena{
    width: 92%;
    margin: 0 auto;
    display:grid;
    grid-template-columns: 1fr;
    gap: 10px;
  }

  .bigPanel{
    width:100%;
    height: 320px;
    display:flex;
    align-items:center;
    justify-content:center;
    padding: 14px;
  }

  .wheelWrap{
    width: 280px;
    height: 280px;
    border-radius: 999px;
    border:2px solid rgba(255,255,255,0.7);
    position:relative;
    background: radial-gradient(circle at 50% 50%, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.35) 62%, rgba(0,0,0,0.2) 100%);
  }

  .slot{
    position:absolute;
    width: 34px;
    height: 26px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:900;
    font-size:14px;
    border:2px solid rgba(255,255,255,0.25);
    background: rgba(255,255,255,0.06);
    color:#fff;
    box-sizing:border-box;
  }
  .slot.active{
    border-color: rgba(255, 255, 160, 0.95);
    background: rgba(255, 220, 0, 0.16);
    box-shadow: 0 0 14px rgba(255,220,0,0.35);
  }

  .rpsCenter{
    position:absolute;
    left:50%; top:50%;
    transform: translate(-50%, -50%);
    width: 120px;
    height: 120px;
    border-radius: 999px;
    border:2px solid rgba(255,255,255,0.75);
    background: radial-gradient(circle at 50% 50%, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.35) 100%);
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .rpsInnerRing{
    width: 92px; height: 92px;
    border-radius: 999px;
    border:2px solid rgba(255,40,40,0.85);
    display:flex;
    align-items:center;
    justify-content:center;
  }
  #rpsIcon{
    font-size:52px;
    filter: drop-shadow(0 0 8px rgba(255,255,255,0.12));
  }

  .pickRow{
    width: 92%;
    margin: 12px auto 0;
    display:flex;
    justify-content:center;
    gap:14px;
  }
  .pickBtn{
    width: 140px;
    height: 44px;
    border-radius: 999px;
    font-size:16px;
    background: rgba(0,0,0,0.35);
  }

  /* ===== 3페이지(결과) ===== */
  .s3Box{
    width: 92%;
    margin: 14px auto 0;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap: 14px;
  }
  .gainBox{
    width: 82%;
    max-width: 520px;
    padding: 12px 14px;
    border:2px solid rgba(255,255,255,0.7);
    background: #ffd84a;
    color:#ff1c1c;
    font-weight:1000;
    font-size:30px;
    text-align:center;
    animation: blink 0.9s steps(1) infinite;
  }
  @keyframes blink{
    0%{ filter: brightness(1); }
    50%{ filter: brightness(0.75); }
    100%{ filter: brightness(1); }
  }

  .s3TalkRow{
    width: 92%;
    display:flex;
    align-items:center;
    justify-content:center;
    gap: 14px;
  }
  .s3Stranger{
    width: 260px;
    height: 260px;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:10px;
    flex: 0 0 auto;
  }
  .s3Stranger img{ width:100%; height:100%; object-fit:contain; pointer-events:none; }
  .s3TalkRow .bubble{ flex:1; min-height:78px; }

</style>
</head>

<body>
<div class="wrap">
  <div id="scaleRoot">
    <div class="frame">

      <div class="titleBar card">
        <div>어둠의 거래소</div>
        <small id="roundTop">- ROUND 1</small>
      </div>

      <!-- ========== VIEW 1 ========== -->
      <section id="view1" class="view active">
        <!-- ✅ 요청: 1페이지도 stranger.png 오른쪽에 말풍선 유지 -->
        <div class="s1Top">
          <div class="s1Stranger card">
            <img class="pixel" src="static/stranger.png" alt="stranger">
          </div>
          <div class="bubble card" id="bubble1"></div>
        </div>

        <div class="s1Center">
          <!-- ✅ 요청: 가운데 문장 버튼 -->
          <button id="entryBtn" class="entryBtn">
            게임 참가비는 ♥ 2개일세. 게임을 하겠는가? 내 제안에 응하겠다면 아래 중 아무 버튼이나 눌러.
          </button>

          <!-- ✅ 요청: 아래 동그라미 버튼 3개(아무거나 눌러도 다음 화면) -->
          <div class="circleRow">
            <button class="circleBtn" data-go="2" aria-label="go1"></button>
            <button class="circleBtn" data-go="2" aria-label="go2"></button>
            <button class="circleBtn" data-go="2" aria-label="go3"></button>
          </div>
        </div>
      </section>

      <!-- ========== VIEW 2 ========== -->
      <section id="view2" class="view">
        <div class="s2Top">
          <div class="s2StrangerSmall card">
            <img class="pixel" src="static/stranger.png" alt="stranger">
          </div>
          <div class="bubble card" id="bubble2"></div>
        </div>

        <div class="rpsBanner card" id="resultBanner">가위..바위..보!</div>

        <div class="arena">
          <div class="bigPanel card">
            <div class="wheelWrap" id="wheel">
              <div class="rpsCenter">
                <div class="rpsInnerRing">
                  <div id="rpsIcon">✌️</div>
                </div>
              </div>
            </div>
          </div>

          <div class="pickRow">
            <button class="pickBtn" id="btnRock">바위</button>
            <button class="pickBtn" id="btnScissors">가위</button>
            <button class="pickBtn" id="btnPaper">보</button>
          </div>
        </div>
      </section>

      <!-- ========== VIEW 3 ========== -->
      <section id="view3" class="view">
        <div class="s3Box">
          <div class="gainBox card" id="gainBox">획득 ♥ +0</div>

          <div class="s3TalkRow">
            <div class="s3Stranger card">
              <img class="pixel" src="static/stranger.png" alt="stranger">
            </div>
            <div class="bubble card" id="bubble3"></div>
          </div>

          <div class="circleRow">
            <button class="circleBtn" data-retry="1" aria-label="retry1"></button>
            <button class="circleBtn" data-retry="1" aria-label="retry2"></button>
            <button class="circleBtn" data-retry="1" aria-label="retry3"></button>
          </div>
        </div>
      </section>

      <!-- audio -->
      <audio id="aChoice" src="static/choice.mp3" preload="auto"></audio>
      <audio id="aSquid"  src="static/squidgame.mp3" preload="auto"></audio>
      <audio id="aWin"    src="static/win.mp3" preload="auto"></audio>
      <audio id="aLose"   src="static/lose.mp3" preload="auto"></audio>
      <audio id="aRetry"  src="static/retry.mp3" preload="auto"></audio>

    </div>
  </div>
</div>

<script>
/* iOS 주소창 높이 대응 */
function setVh(){
  document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
}
window.addEventListener('load', setVh);
window.addEventListener('resize', setVh);

/* iOS 바운스/스크롤 완전 차단 */
document.addEventListener('touchmove', (e)=>{ e.preventDefault(); }, { passive:false });

/* 한 화면 자동 축소 */
function fitToScreen(){
  const root = document.getElementById('scaleRoot');
  const frame = document.querySelector('.frame');
  if(!root || !frame) return;

  const vw = window.innerWidth;
  const vh = window.innerHeight;

  const baseW = root.offsetWidth;
  const baseH = frame.offsetHeight + 10;

  const s = Math.min(1, vw / baseW, vh / baseH);
  root.style.transform = `scale(${s})`;
  root.style.transformOrigin = 'top center';
}
window.addEventListener('load', fitToScreen);
window.addEventListener('resize', fitToScreen);

/* =========================================================
   설정/데이터
   ========================================================= */
const STAKE_HEARTS = 2;

/* ✅ 배수 분포(요구사항) : 1배수 1개, 5배수 1개, 2배수 8개, 3배수 3개 */
const MULTIPLIERS = [
  1, 2,
  2,2,5,2,3,2,2,2,
  3,3,2
];

const S1_QUOTES = [
  "목숨을 거래하러 왔나?\n몇개의 목숨을 내놓을지 정해.",
  "또왔나?",
  "우리 와이프보다 자주 보는구,\n.....불사신인가?",
  "이러다 다 죽어!",
  "도박중독 상담은 국번없이 1336이라네"
];
const S2_QUOTES = [
  "베짱이 대단하군",
  "지옥같은 세상에서 우리같은 사람들이 가진거라곤 목숨밖에 없는 인생이지..",
  "단골 되겠어",
  "자꾸 살아남는걸 보니 자네는 운이 좋나보군",
  "오늘도 럭키비키이길.."
];

const rpsCycle = ["rock","scissors","paper"]; // 바위->가위->보
const rpsIconMap = { rock:"✊", scissors:"✌️", paper:"✋" };

/* =========================================================
   DOM
   ========================================================= */
const view1 = document.getElementById('view1');
const view2 = document.getElementById('view2');
const view3 = document.getElementById('view3');

const roundTop = document.getElementById('roundTop');
const bubble1 = document.getElementById('bubble1');
const bubble2 = document.getElementById('bubble2');
const bubble3 = document.getElementById('bubble3');

const entryBtn = document.getElementById('entryBtn');

const resultBanner = document.getElementById('resultBanner');
const wheelEl = document.getElementById('wheel');
const rpsIcon = document.getElementById('rpsIcon');
const gainBox = document.getElementById('gainBox');

const btnRock = document.getElementById('btnRock');
const btnScissors = document.getElementById('btnScissors');
const btnPaper = document.getElementById('btnPaper');

const aChoice = document.getElementById('aChoice');
const aSquid  = document.getElementById('aSquid');
const aWin    = document.getElementById('aWin');
const aLose   = document.getElementById('aLose');
const aRetry  = document.getElementById('aRetry');

/* 모바일 오디오 안정화 */
let audioUnlocked = false;
async function playSoundSafe(a){
  try{
    a.pause();
    try{ a.currentTime = 0; }catch(e){}
    const p = a.play();
    if(p && p.catch) await p.catch(()=>{});
  }catch(e){}
}
function unlockAudioOnce(){
  if(audioUnlocked) return;
  audioUnlocked = true;
  [aChoice,aSquid,aWin,aLose,aRetry].forEach(a=>{
    try{
      a.muted = true;
      a.play().then(()=>{
        a.pause(); a.currentTime = 0; a.muted = false;
      }).catch(()=>{ a.muted = false; });
    }catch(e){}
  });
}
window.addEventListener('touchstart', unlockAudioOnce, { once:true, passive:true });
window.addEventListener('mousedown',  unlockAudioOnce, { once:true });

/* =========================================================
   상태
   ========================================================= */
let round = 1;
let phase = 1;
let spinning = false;

let rpsSpinTimer = null;
let rpsSpinSpeedMs = 85;
let rpsCursor = 0;

let playerPick = null;
let jankenPick = "rock";

let rpsBag = [];
let multBag = [];

/* =========================================================
   유틸: 랜덤 뭉침 완화(bag)
   ========================================================= */
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}
function bagNext(type, pool){
  if(type === "rps"){
    if(rpsBag.length === 0) rpsBag = shuffle(pool.slice());
    return rpsBag.pop();
  }
  if(type === "mult"){
    if(multBag.length === 0) multBag = shuffle(pool.slice());
    return multBag.pop();
  }
  return pool[Math.floor(Math.random()*pool.length)];
}

/* =========================================================
   라운드별 대사(순서대로 반복)
   ========================================================= */
function quoteByRound(arr){
  const idx = (round - 1) % arr.length; // 1~5 반복
  return arr[idx];
}
function setRoundUI(){
  roundTop.textContent = `- ROUND ${round}`;
  document.title = `어둠의 거래소 - ROUND ${round}`;

  // ✅ 1페이지 말풍선: 라운드별 대사 순서대로
  bubble1.textContent = quoteByRound(S1_QUOTES);

  // ✅ 2페이지 말풍선도 라운드별 대사 순서대로
  bubble2.textContent = quoteByRound(S2_QUOTES);
}

/* =========================================================
   숫자판 생성(13칸)
   ========================================================= */
let slotEls = [];
function buildWheelSlots(){
  slotEls.forEach(el=>el.remove());
  slotEls = [];

  const n = MULTIPLIERS.length; // 13
  const cx = 140, cy = 140;
  const radius = 118;

  for(let i=0;i<n;i++){
    const ang = (-90 + (360*i/n)) * Math.PI/180;
    const x = cx + Math.cos(ang)*radius;
    const y = cy + Math.sin(ang)*radius;

    const d = document.createElement('div');
    d.className = 'slot';
    d.textContent = MULTIPLIERS[i];
    d.style.left = (x - 17) + 'px';
    d.style.top  = (y - 13) + 'px';
    wheelEl.appendChild(d);
    slotEls.push(d);
  }
}
buildWheelSlots();

function showView(n){
  [view1,view2,view3].forEach(v=>v.classList.remove('active'));
  if(n===1) view1.classList.add('active');
  if(n===2) view2.classList.add('active');
  if(n===3) view3.classList.add('active');
  phase = n;
  fitToScreen();
}

/* RPS 스핀 */
function startRpsIdle(){
  stopRpsIdle();
  rpsSpinSpeedMs = 85;
  rpsCursor = 0;
  rpsIcon.textContent = rpsIconMap[rpsCycle[rpsCursor]];
  rpsSpinTimer = setInterval(()=>{
    rpsCursor = (rpsCursor + 1) % rpsCycle.length;
    jankenPick = rpsCycle[rpsCursor];
    rpsIcon.textContent = rpsIconMap[jankenPick];
  }, rpsSpinSpeedMs);
}
function stopRpsIdle(){
  if(rpsSpinTimer){ clearInterval(rpsSpinTimer); rpsSpinTimer = null; }
}

/* 승무패 판정 */
function judge(player, enemy){
  if(player === enemy) return "draw";
  if(
    (player==="rock" && enemy==="scissors") ||
    (player==="scissors" && enemy==="paper") ||
    (player==="paper" && enemy==="rock")
  ) return "win";
  return "lose";
}

/* 버튼 잠금 */
function setPickEnabled(on){
  [btnRock,btnScissors,btnPaper].forEach(b=>{
    b.disabled = !on;
    b.style.opacity = on ? "1" : "0.55";
    b.style.pointerEvents = on ? "auto" : "none";
  });
}

/* 숫자판 */
function clearSlots(){
  slotEls.forEach(s=>s.classList.remove('active'));
}
function spinSlotsAndStop(stopIndex){
  return new Promise(resolve=>{
    const n = slotEls.length;
    let idx = 0;
    clearSlots();

    const totalSteps = 28 + Math.floor(Math.random()*10);
    let steps = 0;

    const fast = 55;
    const slowStartAt = totalSteps - (n + 6);
    let delay = fast;

    function tick(){
      clearSlots();
      slotEls[idx].classList.add('active');

      steps++;
      if(steps >= slowStartAt) delay += 14;

      idx = (idx + 1) % n;

      if(steps >= totalSteps){
        idx = stopIndex;
        clearSlots();
        slotEls[idx].classList.add('active');
        setTimeout(()=>resolve(), 320);
        return;
      }
      setTimeout(tick, delay);
    }
    tick();
  });
}

/* =========================================================
   게임 진행
   ========================================================= */
async function onPick(pick){
  if(spinning) return;
  spinning = true;
  setPickEnabled(false);

  playerPick = pick;

  await playSoundSafe(aChoice);
  setTimeout(()=>{ playSoundSafe(aSquid); }, 120);

  const squidDur = isFinite(aSquid.duration) && aSquid.duration > 0 ? aSquid.duration : 5.2;

  stopRpsIdle();
  rpsSpinSpeedMs = 65;
  let localTimer = setInterval(()=>{
    rpsCursor = (rpsCursor + 1) % rpsCycle.length;
    jankenPick = rpsCycle[rpsCursor];
    rpsIcon.textContent = rpsIconMap[jankenPick];
  }, rpsSpinSpeedMs);

  setTimeout(()=>{
    clearInterval(localTimer);
    rpsSpinSpeedMs = 220;
    localTimer = setInterval(()=>{
      rpsCursor = (rpsCursor + 1) % rpsCycle.length;
      jankenPick = rpsCycle[rpsCursor];
      rpsIcon.textContent = rpsIconMap[jankenPick];
    }, rpsSpinSpeedMs);
  }, 2000);

  const finalAt = Math.max(2400, Math.floor(squidDur*1000) - 200);
  setTimeout(()=>{
    clearInterval(localTimer);

    jankenPick = bagNext("rps", rpsCycle);
    rpsIcon.textContent = rpsIconMap[jankenPick];

    const res = judge(playerPick, jankenPick);

    if(res === "win") resultBanner.textContent = "승리!";
    if(res === "draw") resultBanner.textContent = "무승부!";
    if(res === "lose") resultBanner.textContent = "패배!";

    setTimeout(async ()=>{
      if(res === "win") await playSoundSafe(aWin);
      if(res === "lose") await playSoundSafe(aLose);
      if(res === "draw") await playSoundSafe(aRetry);

      let multiplier = 1;

      if(res === "win"){
        const chosen = bagNext("mult", MULTIPLIERS);
        multiplier = chosen;

        const candidates = [];
        for(let i=0;i<MULTIPLIERS.length;i++){
          if(MULTIPLIERS[i] === chosen) candidates.push(i);
        }
        const stopIndex = candidates[Math.floor(Math.random()*candidates.length)];
        await spinSlotsAndStop(stopIndex);
      }else{
        clearSlots();
      }

      let gain = 0;
      if(res === "win") gain = STAKE_HEARTS * multiplier;
      if(res === "draw") gain = STAKE_HEARTS;
      if(res === "lose") gain = 0;

      gainBox.textContent = `획득 ♥ +${gain}`;

      if(res === "win") bubble3.textContent = "축하하네, 다시 도전하려면 아무 버튼이나 누르면 된다네.";
      if(res === "draw") bubble3.textContent = "비겼군, 다시 도전하려면 아무 버튼이나 누르면 된다네.";
      if(res === "lose") bubble3.textContent = "푸하하! 네 하트는 소중하게 보관해주겠네";

      setTimeout(()=>{
        showView(3);
        spinning = false;
      }, 350);
    }, 250);
  }, finalAt);
}

/* 3페이지 -> 다음 라운드 */
function nextRound(){
  round++;
  setRoundUI();

  clearSlots();
  resultBanner.textContent = "가위..바위..보!";
  startRpsIdle();
  setPickEnabled(true);
  spinning = false;

  showView(1);
}

/* 1페이지 -> 2페이지 */
function goToGame(){
  setRoundUI();        // ✅ round 대사/제목 갱신
  showView(2);
  startRpsIdle();
  setPickEnabled(true);
}

/* 이벤트 */
entryBtn.addEventListener('click', goToGame);
document.querySelectorAll('[data-go="2"]').forEach(b=> b.addEventListener('click', goToGame));

btnRock.addEventListener('click', ()=>onPick("rock"));
btnScissors.addEventListener('click', ()=>onPick("scissors"));
btnPaper.addEventListener('click', ()=>onPick("paper"));

document.querySelectorAll('[data-retry="1"]').forEach(b=> b.addEventListener('click', nextRound));

/* 시작 */
(function init(){
  setRoundUI();        // ✅ 1페이지 말풍선부터 라운드 대사 적용
  showView(1);
  fitToScreen();
})();
</script>
</body>
</html>
