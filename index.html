<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>어둠의 거래소 - ROUND 1</title>

<style>
  html,body{
    margin:0; padding:0; width:100%; height:100%;
    overflow:hidden; overscroll-behavior:none; touch-action:none;
    background:#000;
    font-family: Arial, Helvetica, sans-serif;
    color:#f2f2f2;

  }
  :root{ --vh:1vh; }
  body{ height: calc(var(--vh) * 100); }

  .wrap{ width:100%; height:100%; display:flex; justify-content:center; }
  #scaleRoot{ width: 980px; transform-origin: top center; }
  .frame{
    width: 940px;
    margin: 10px auto 0;
    border:2px solid rgba(255,255,255,0.65);
    background: radial-gradient(circle at 50% 35%, #101018 0%, #06060a 55%, #000 100%);
    box-sizing:border-box;
    padding: 10px 12px 14px;
  }

  .pixel{
    image-rendering: pixelated;
    image-rendering: crisp-edges;
  }

  .titleBar{
    height: 44px;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:14px;
    color:#fff;
    font-weight:800;
    letter-spacing:0.5px;
    border:2px solid rgba(255,255,255,0.45);
    background: repeating-linear-gradient(
      90deg,
      rgba(255,255,255,0.05) 0px,
      rgba(255,255,255,0.05) 12px,
      rgba(255,255,255,0.0) 12px,
      rgba(255,255,255,0.0) 24px
    );
  }
  .titleBar small{ opacity:0.9; font-weight:700; }

  .view{ display:none; }
  .view.active{ display:block; }

  .card{
    border:2px solid rgba(255,255,255,0.55);
    background: rgba(0,0,0,0.35);
    box-sizing:border-box;
  }

  /* 말풍선(왼쪽 꼬리) */
  .bubble{
    position:relative;
    padding: 12px 14px;
    min-height: 64px;
    display:flex;
    align-items:center;
    font-weight:800;
    font-size:16px;
    line-height:1.2;
    border:2px solid rgba(255,255,255,0.65);
    background: rgba(10,10,16,0.65);
    text-align:left;
    box-sizing:border-box;
    white-space:pre-line;
  }
  .bubble::before{
    content:"";
    position:absolute;
    left:-12px;
    top:22px;
    width:0; height:0;
    border-top:10px solid transparent;
    border-bottom:10px solid transparent;
    border-right:12px solid rgba(255,255,255,0.65);
  }
  .bubble::after{
    content:"";
    position:absolute;
    left:-9px;
    top:23px;
    width:0; height:0;
    border-top:9px solid transparent;
    border-bottom:9px solid transparent;
    border-right:11px solid rgba(10,10,16,0.65);
  }

  button{
    border:2px solid rgba(255,255,255,0.7);
    background: rgba(0,0,0,0.25);
    color:#fff;
    font-weight:800;
    cursor:pointer;
    user-select:none;
    -webkit-user-select:none;
    touch-action: manipulation;
  }
  button:active{ transform: translateY(1px); }
  button:disabled{
    opacity:0.55;
    cursor:not-allowed;
    pointer-events:none;
  }

  /* ===== 1페이지(입장) ===== */
  .s1Top{
    width: 92%;
    margin: 14px auto 0;
    display:flex;
    align-items:center;
    justify-content:center;
    gap: 14px;
  }
  .s1Stranger{
    width: 220px;
    height: 200px;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:10px;
    flex: 0 0 auto;
  }
  .s1Stranger img{
    width:100%; height:100%;
    object-fit:contain;
    pointer-events:none;
  }
  .s1Top .bubble{ flex:1; }

  .s1Center{
    width: 92%;
    margin: 16px auto 0;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap: 14px;
  }

  .hintLine{
    width: 92%;
    max-width: 820px;
    padding: 12px 14px;
    border:2px solid rgba(255,255,255,0.35);
    background: rgba(255,255,255,0.04);
    font-weight:900;
    text-align:center;
    box-sizing:border-box;
    line-height:1.25;
  }
  .red{ color:#ff4040; }

  .riskRow{
    width: 92%;
    max-width: 880px;
    display:grid;
    grid-template-columns: 1fr 1fr 1fr 1fr;
    gap: 10px;
  }
  .riskBtn{
    height: 52px;
    font-size:13px;
    border-radius: 999px;
    background: rgba(0,0,0,0.35);
    padding: 8px 10px;
    line-height:1.1;
  }

  /* ===== 2페이지(게임) ===== */
  .s2Top{
    width: 92%;
    margin: 14px auto 0;
    display:flex;
    align-items:center;
    justify-content:center;
    gap: 14px;
  }
  .s2StrangerSmall{
    width: 150px;
    height: 120px;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:8px;
    flex: 0 0 auto;
  }
  .s2StrangerSmall img{
    width:100%; height:100%;
    object-fit:contain;
    pointer-events:none;
  }
  .s2Top .bubble{ flex:1; min-height:64px; }

  .rpsBanner{
    width: 92%;
    margin: 14px auto 10px;
    padding: 12px;
    text-align:center;
    font-weight:900;
    font-size:32px;
    border:2px solid rgba(255,255,255,0.6);
    background: rgba(0,0,0,0.3);
  }

  .arena{
    width: 92%;
    margin: 0 auto;
    display:grid;
    grid-template-columns: 1fr;
    gap: 10px;
  }

  .bigPanel{
    width:100%;
    height: 320px;
    display:flex;
    align-items:center;
    justify-content:center;
    padding: 14px;
  }

  /* ✅ 숫자 둘레 제거: 중앙 LED만 */
  .ledOnly{
    width: 220px;
    height: 220px;
    border-radius: 999px;
    border:2px solid rgba(255,255,255,0.7);
    position:relative;
    background: radial-gradient(circle at 50% 50%, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.35) 70%, rgba(0,0,0,0.2) 100%);
    display:flex;
    align-items:center;
    justify-content:center;
  }

  .rpsInnerRing{
    width: 150px; height: 150px;
    border-radius: 999px;
    border:2px solid rgba(255,40,40,0.85);
    display:flex;
    align-items:center;
    justify-content:center;
  }
  #rpsIcon{
    font-size:66px;
    filter: drop-shadow(0 0 10px rgba(255,255,255,0.12));
  }

  .pickRow{
    width: 92%;
    margin: 12px auto 0;
    display:flex;
    justify-content:center;
    gap:14px;
  }
  .pickBtn{
    width: 140px;
    height: 44px;
    border-radius: 999px;
    font-size:16px;
    background: rgba(0,0,0,0.35);
  }

  /* ===== 3페이지(결과) ===== */
  .s3Box{
    width: 92%;
    margin: 14px auto 0;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap: 14px;
  }
  .gainBox{
    width: 82%;
    max-width: 680px;
    padding: 12px 14px;
    border:2px solid rgba(255,255,255,0.7);
    background: #ffd84a;
    color:#ff1c1c;
    font-weight:1000;
    font-size:26px;
    text-align:center;
    animation: blink 0.9s steps(1) infinite;
    line-height:1.15;
  }
  @keyframes blink{
    0%{ filter: brightness(1); }
    50%{ filter: brightness(0.75); }
    100%{ filter: brightness(1); }
  }

  .s3TalkRow{
    width: 92%;
    display:flex;
    align-items:center;
    justify-content:center;
    gap: 14px;
  }
  .s3Stranger{
    width: 260px;
    height: 260px;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:10px;
    flex: 0 0 auto;
  }
  .s3Stranger img{ width:100%; height:100%; object-fit:contain; pointer-events:none; }
  .s3TalkRow .bubble{ flex:1; min-height:78px; }

  .circleRow{
    display:flex;
    justify-content:center;
    gap:14px;
    margin-top: 6px;
  }
  .circleBtn{
    width: 92px;
    height: 44px;
    border-radius:999px;
    font-size:14px;
    background: rgba(0,0,0,0.35);
  }

  @media (max-width: 860px){
    .riskRow{ grid-template-columns: 1fr 1fr; }
    .riskBtn{ height: 56px; font-size:13px; }
  }
</style>
</head>

<body>
<div class="wrap">
  <div id="scaleRoot">
    <div class="frame">

      <div class="titleBar card">
        <div>어둠의 거래소</div>
        <small id="roundTop">- ROUND 1</small>
      </div>

      <!-- ========== VIEW 1 ========== -->
      <section id="view1" class="view active">
        <div class="s1Top">
          <div class="s1Stranger card">
            <img class="pixel" src="static/stranger.png" alt="stranger">
          </div>

          <!-- ✅ 말풍선은 텍스트만 (클릭해도 아무 기능 없음) -->
          <div class="bubble card" id="bubble1"></div>
        </div>

        <div class="s1Center">
          <div class="hintLine" id="hintLine"></div>

          <div class="riskRow">
            <button class="riskBtn" data-win="0.50" data-mult="1">승리확률 50%, 보상 1배</button>
            <button class="riskBtn" data-win="0.40" data-mult="2">승리확률 40%, 보상 2배</button>
            <button class="riskBtn" data-win="0.30" data-mult="3">승리확률 30%, 보상 3배</button>
            <button class="riskBtn" data-win="0.10" data-mult="4">승리확률 10%, 보상 4배</button>
          </div>
        </div>
      </section>

      <!-- ========== VIEW 2 ========== -->
      <section id="view2" class="view">
        <div class="s2Top">
          <div class="s2StrangerSmall card">
            <img class="pixel" src="static/stranger.png" alt="stranger">
          </div>
          <div class="bubble card" id="bubble2"></div>
        </div>

        <div class="rpsBanner card" id="resultBanner">가위..바위..보!</div>

        <div class="arena">
          <div class="bigPanel card">
            <div class="ledOnly" id="ledOnly">
              <div class="rpsInnerRing">
                <div id="rpsIcon">✌️</div>
              </div>
            </div>
          </div>

          <div class="pickRow">
            <button class="pickBtn" id="btnRock">바위</button>
            <button class="pickBtn" id="btnScissors">가위</button>
            <button class="pickBtn" id="btnPaper">보</button>
          </div>
        </div>
      </section>

      <!-- ========== VIEW 3 ========== -->
      <section id="view3" class="view">
        <div class="s3Box">
          <div class="gainBox card" id="gainBox">획득 ♥ +0</div>

          <div class="s3TalkRow">
            <div class="s3Stranger card">
              <img class="pixel" src="static/stranger.png" alt="stranger">
            </div>
            <div class="bubble card" id="bubble3"></div>
          </div>

          <div class="circleRow">
            <button class="circleBtn" data-retry="1" aria-label="retry1"></button>
            <button class="circleBtn" data-retry="1" aria-label="retry2"></button>
            <button class="circleBtn" data-retry="1" aria-label="retry3"></button>
          </div>
        </div>
      </section>

      <!-- audio -->
      <audio id="aChoice" src="static/choice.mp3" preload="auto"></audio>
      <audio id="aSquid"  src="static/squidgame.mp3" preload="auto"></audio>
      <audio id="aWin"    src="static/win.mp3" preload="auto"></audio>
      <audio id="aLose"   src="static/loose.mp3" preload="auto"></audio>
      <audio id="aRetry"  src="static/retry.mp3" preload="auto"></audio>

    </div>
  </div>
</div>

<script>
function setVh(){
  document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
}
window.addEventListener('load', setVh);
window.addEventListener('resize', setVh);

document.addEventListener('touchmove', (e)=>{ e.preventDefault(); }, { passive:false });

function fitToScreen(){
  const root = document.getElementById('scaleRoot');
  const frame = document.querySelector('.frame');
  if(!root || !frame) return;

  const vw = window.innerWidth;
  const vh = window.innerHeight;

  const baseW = root.offsetWidth;
  const baseH = frame.offsetHeight + 10;

  const s = Math.min(1, vw / baseW, vh / baseH);
  root.style.transform = `scale(${s})`;
  root.style.transformOrigin = 'top center';
}
window.addEventListener('load', fitToScreen);
window.addEventListener('resize', fitToScreen);

/* =======================
   설정/데이터
   ======================= */
const STAKE_HEARTS = 2;

let WIN_PROB = 0.5;      // 버튼 선택 승리확률(기본값)
let REWARD_MULT = 1;     // 버튼 선택 보상 배수

// ✅ 1페이지 첫 대사 수정
const S1_QUOTES = [
  "목숨을 거래하러 왔나?",
  "또왔나?",
  "우리 와이프보다 자주 보는구,\n.....불사신인가?",
  "이러다 다 죽어!",
  "도박중독 상담은 국번없이 1336이라네"
];
const S2_QUOTES = [
  "베짱이 대단하군",
  "지옥같은 세상에서 우리같은 사람들이 가진거라곤 목숨밖에 없는 인생이지..",
  "단골 되겠어",
  "자꾸 살아남는걸 보니 자네는 운이 좋나보군",
  "오늘도 럭키비키이길.."
];

const rpsCycle = ["rock","scissors","paper"];
const rpsIconMap = { rock:"✊", scissors:"✌️", paper:"✋" };

/* =======================
   DOM
   ======================= */
const view1 = document.getElementById('view1');
const view2 = document.getElementById('view2');
const view3 = document.getElementById('view3');

const roundTop = document.getElementById('roundTop');
const bubble1 = document.getElementById('bubble1');
const bubble2 = document.getElementById('bubble2');
const bubble3 = document.getElementById('bubble3');
const hintLine = document.getElementById('hintLine');

const resultBanner = document.getElementById('resultBanner');
const rpsIcon = document.getElementById('rpsIcon');
const gainBox = document.getElementById('gainBox');

const btnRock = document.getElementById('btnRock');
const btnScissors = document.getElementById('btnScissors');
const btnPaper = document.getElementById('btnPaper');

const aChoice = document.getElementById('aChoice');
const aSquid  = document.getElementById('aSquid');
const aWin    = document.getElementById('aWin');
const aLose   = document.getElementById('aLose');
const aRetry  = document.getElementById('aRetry');

/* 모바일 오디오 안정화 */
let audioUnlocked = false;
async function playSoundSafe(a){
  try{
    a.pause();
    try{ a.currentTime = 0; }catch(e){}
    const p = a.play();
    if(p && p.catch) await p.catch(()=>{});
  }catch(e){}
}
function unlockAudioOnce(){
  if(audioUnlocked) return;
  audioUnlocked = true;
  [aChoice,aSquid,aWin,aLose,aRetry].forEach(a=>{
    try{
      a.muted = true;
      a.play().then(()=>{
        a.pause(); a.currentTime = 0; a.muted = false;
      }).catch(()=>{ a.muted = false; });
    }catch(e){}
  });
}
window.addEventListener('touchstart', unlockAudioOnce, { once:true, passive:true });
window.addEventListener('mousedown',  unlockAudioOnce, { once:true });

/* =======================
   상태
   ======================= */
let round = 1;
let phase = 1;
let spinning = false;

let rpsSpinTimer = null;
let rpsSpinSpeedMs = 85;
let rpsCursor = 0;

let playerPick = null;
let jankenPick = "rock";

// ✅ 연속 결과 보정용 카운터
let loseStreak = 0;   // 무승부/패배 연속 횟수

/* =======================
   라운드별 대사/타이틀
   ======================= */
function quoteByRound(arr){
  const idx = (round - 1) % arr.length;
  return arr[idx];
}
function setRoundUI(){
  roundTop.textContent = `- ROUND ${round}`;
  document.title = `어둠의 거래소 - ROUND ${round}`;
  bubble1.textContent = quoteByRound(S1_QUOTES);
  bubble2.textContent = quoteByRound(S2_QUOTES);

  // ✅ 안내 문구 교체(+ ♥2개 빨간색)
  hintLine.innerHTML =
    `게임을 하고싶다면 <span class="red">♥ 2개</span>를 베팅해야 한다네.<br>` +
    `준비가 되었다면 아래 게임 조건을 고르게.`;
}

/* =======================
   View 전환
   ======================= */
function showView(n){
  [view1,view2,view3].forEach(v=>v.classList.remove('active'));
  if(n===1) view1.classList.add('active');
  if(n===2) view2.classList.add('active');
  if(n===3) view3.classList.add('active');
  phase = n;
  fitToScreen();
}

/* =======================
   RPS 스핀
   ======================= */
function startRpsIdle(){
  stopRpsIdle();
  rpsSpinSpeedMs = 85;
  rpsCursor = 0;
  rpsIcon.textContent = rpsIconMap[rpsCycle[rpsCursor]];
  rpsSpinTimer = setInterval(()=>{
    rpsCursor = (rpsCursor + 1) % rpsCycle.length;
    jankenPick = rpsCycle[rpsCursor];
    rpsIcon.textContent = rpsIconMap[jankenPick];
  }, rpsSpinSpeedMs);
}
function stopRpsIdle(){
  if(rpsSpinTimer){ clearInterval(rpsSpinTimer); rpsSpinTimer = null; }
}

function judge(player, enemy){
  if(player === enemy) return "draw";
  if(
    (player==="rock" && enemy==="scissors") ||
    (player==="scissors" && enemy==="paper") ||
    (player==="paper" && enemy==="rock")
  ) return "win";
  return "lose";
}

function enemyPickForOutcome(player, outcome){
  if(outcome === "draw") return player;
  if(outcome === "win"){
    if(player === "rock") return "scissors";
    if(player === "scissors") return "paper";
    return "rock";
  }
  if(player === "rock") return "paper";
  if(player === "scissors") return "rock";
  return "scissors";
}

function setPickEnabled(on){
  [btnRock,btnScissors,btnPaper].forEach(b=> b.disabled = !on);
}

/* =======================
   ✅ “덜 뭉치게” + “연속 비승이면 승리 유도”
   규칙:
   - 비승 1번 연속이면 승리확률을 보너스(+0.18) 올림
   - 무승부 확률은 작게 고정(기본 6%), 대신 승리/패배가 핵심
   ======================= */
function chooseOutcomeBalanced(){
  // ✅ 패배가 2번 연속이면 다음 판은 "패배"가 나오지 않게 강제
  // (무승부는 허용)
  const drawProb = 0.30;

  // 기본 승리확률 + (패배가 1번 연속일 때) 체감 보너스
  let wp = WIN_PROB;
  if(loseStreak === 1) wp = Math.min(0.92, wp + 0.08);

  // loseStreak>=2면 lose를 금지 => win/draw 중에서만 뽑기
  if(loseStreak >= 2){
    const total = wp + drawProb;
    const r = Math.random() * total;
    return (r < wp) ? "win" : "draw";
  }

  // 일반 케이스: win / draw / lose
  const r = Math.random();
  if(r < wp) return "win";
  if(r < wp + drawProb) return "draw";
  return "lose";
}


/* =======================
   보상 문구(요청 방식)
   ======================= */
function buildGainMessage(result){
  if(result === "win"){
    const add = STAKE_HEARTS * REWARD_MULT;
    return `♥ ${add}개를 추가로 획득합니다`;
  }
  if(result === "draw"){
    return `추가획득 ♥ 없음. ♥개수가 유지됩니다.`;
  }
  return `♥ ${STAKE_HEARTS}개를 잃습니다.`;
}

/* =======================
   게임 진행
   ======================= */
async function onPick(pick){
  if(spinning) return;
  spinning = true;
  setPickEnabled(false);

  playerPick = pick;

  await playSoundSafe(aChoice);
  setTimeout(()=>{ playSoundSafe(aSquid); }, 120);

  const squidDur = isFinite(aSquid.duration) && aSquid.duration > 0 ? aSquid.duration : 5.2;

  stopRpsIdle();

  // 빠르게 돌기
  let localTimer = setInterval(()=>{
    rpsCursor = (rpsCursor + 1) % rpsCycle.length;
    jankenPick = rpsCycle[rpsCursor];
    rpsIcon.textContent = rpsIconMap[jankenPick];
  }, 65);

  // 2초 후 느리게
  setTimeout(()=>{
    clearInterval(localTimer);
    localTimer = setInterval(()=>{
      rpsCursor = (rpsCursor + 1) % rpsCycle.length;
      jankenPick = rpsCycle[rpsCursor];
      rpsIcon.textContent = rpsIconMap[jankenPick];
    }, 220);
  }, 2000);

  const finalAt = Math.max(2400, Math.floor(squidDur*1000) - 200);

  setTimeout(async ()=>{
    clearInterval(localTimer);

    // ✅ 결과를 “체감 보정 로직”으로 결정
    const forcedOutcome = chooseOutcomeBalanced();
    jankenPick = enemyPickForOutcome(playerPick, forcedOutcome);
    rpsIcon.textContent = rpsIconMap[jankenPick];

    const res = judge(playerPick, jankenPick);

    if(res === "win") resultBanner.textContent = "승리!";
    if(res === "draw") resultBanner.textContent = "무승부!";
    if(res === "lose") resultBanner.textContent = "패배!";

    // ✅ 연속 비승 카운트 갱신
    if(res === "lose") loseStreak++; 
    else loseStreak = 0; // win 또는 draw면 패배연속 끊김

    setTimeout(async ()=>{
      if(res === "win") await playSoundSafe(aWin);
      if(res === "lose") await playSoundSafe(aLose);
      if(res === "draw") await playSoundSafe(aRetry);

      gainBox.textContent = buildGainMessage(res);

      if(res === "win") bubble3.textContent = "축하하네, 다시 도전하려면 아무 버튼이나 누르면 된다네.";
      if(res === "draw") bubble3.textContent = "비겼군, 다시 도전하려면 아무 버튼이나 누르면 된다네.";
      if(res === "lose") bubble3.textContent = "푸하하! 네 하트는 소중하게 보관해주겠네";

      setTimeout(()=>{
        showView(3);
        spinning = false;
      }, 300);
    }, 250);
  }, finalAt);
}

/* 3페이지 -> 다음 라운드 */
function nextRound(){
  round++;
  setRoundUI();

  resultBanner.textContent = "가위..바위..보!";
  startRpsIdle();
  setPickEnabled(true);
  spinning = false;

  showView(1);
}

/* 1페이지 -> 2페이지 */
function goToGame(){
  setRoundUI();
  showView(2);
  startRpsIdle();
  setPickEnabled(true);
  spinning = false;
}

/* 1페이지 4개 버튼 */
document.querySelectorAll('.riskBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    WIN_PROB = parseFloat(btn.dataset.win);
    REWARD_MULT = parseInt(btn.dataset.mult, 10);
    goToGame();
  });
});

/* 2페이지 선택 버튼 */
btnRock.addEventListener('click', ()=>onPick("rock"));
btnScissors.addEventListener('click', ()=>onPick("scissors"));
btnPaper.addEventListener('click', ()=>onPick("paper"));

/* 3페이지: 아무 버튼 -> 1페이지(라운드+1) */
document.querySelectorAll('[data-retry="1"]').forEach(b=> b.addEventListener('click', nextRound));

/* 시작 */
(function init(){
  setRoundUI();
  showView(1);
  fitToScreen();
})();
</script>
</body>
</html>
